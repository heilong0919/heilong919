<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <title>åå¨è®¢å•æ˜¾ç¤ºç³»ç»Ÿ</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; font-family: -apple-system, sans-serif; }
        body { background: #0f172a; color: #f8fafc; line-height: 1.6; padding: 20px; }
        .container { max-width: 1000px; margin: 0 auto; }
        header { background: linear-gradient(135deg, #ea580c, #dc2626); padding: 25px; border-radius: 16px; margin-bottom: 30px; text-align: center; box-shadow: 0 10px 25px rgba(234, 88, 12, 0.3); }
        .stats { display: flex; justify-content: space-around; background: #1e293b; padding: 20px; border-radius: 12px; margin-bottom: 25px; text-align: center; }
        .stat-box { flex: 1; }
        .stat-number { font-size: 3em; font-weight: 900; color: #fbbf24; line-height: 1.2; }
        .orders-container { display: flex; flex-direction: column; gap: 20px; }
        .order-card {
            background: #1e293b; border-radius: 14px; padding: 25px; border-left: 8px solid #ea580c;
            box-shadow: 0 10px 25px rgba(0,0,0,0.3); animation: pulse-new 2s infinite;
        }
        .order-card.cooking { border-left-color: #0ea5e9; animation: none; }
        @keyframes pulse-new {
            0% { box-shadow: 0 0 0 0 rgba(234, 88, 12, 0.7); }
            70% { box-shadow: 0 0 0 15px rgba(234, 88, 12, 0); }
            100% { box-shadow: 0 0 0 0 rgba(234, 88, 12, 0); }
        }
        .order-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; padding-bottom: 15px; border-bottom: 2px solid #334155; }
        .order-id { font-size: 1.6em; font-weight: 900; color: #fbbf24; }
        .order-time { color: #94a3b8; font-size: 0.95em; }
        .order-status { padding: 6px 18px; border-radius: 20px; font-weight: 800; font-size: 0.9em; }
        .status-new { background: #fed7aa; color: #9a3412; }
        .status-cooking { background: #bae6fd; color: #075985; }
        .order-items { margin: 20px 0; }
        .order-item { display: flex; justify-content: space-between; padding: 12px 0; border-bottom: 1px dashed #475569; }
        .item-total { font-weight: 800; color: #fbbf24; }
        .order-footer { display: flex; justify-content: space-between; align-items: center; margin-top: 20px; padding-top: 20px; border-top: 2px solid #334155; font-size: 1.3em; }
        .order-actions { display: flex; gap: 15px; }
        .action-btn { padding: 10px 20px; border: none; border-radius: 8px; font-weight: 800; cursor: pointer; display: inline-flex; align-items: center; gap: 10px; transition: all 0.2s; }
        .btn-start { background: #0ea5e9; color: white; }
        .btn-finish { background: #10b981; color: white; }
        .action-btn:hover { transform: translateY(-3px); box-shadow: 0 5px 15px rgba(0,0,0,0.4); }
        .empty-state { text-align: center; padding: 60px 30px; color: #64748b; }
        .empty-state i { font-size: 4em; margin-bottom: 20px; color: #334155; }
        .sound-select { padding: 10px; border-radius: 6px; background: #1e293b; color: white; border: 2px solid #475569; margin-left: 15px; }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1><i class="fas fa-fire"></i> åå¨è®¢å•æ˜¾ç¤ºç³»ç»Ÿ</h1>
            <p>å®æ—¶æ¥æ”¶å‰å°è®¢å• | è‡ªåŠ¨æ’­æ”¾æç¤ºéŸ³</p>
            <div style="margin-top: 15px; font-size: 0.9em; color: #fef3c7;">
                æç¤ºéŸ³:
                <select id="soundSelect" class="sound-select">
                    <option value="">-- é€‰æ‹©æç¤ºéŸ³ --</option>
                </select>
                <button onclick="testSelectedSound()" style="margin-left:10px; padding:8px 15px; background:#475569; color:white; border:none; border-radius:6px; cursor:pointer;"><i class="fas fa-play"></i> è¯•å¬</button>
            </div>
        </header>
        <div class="stats">
            <div class="stat-box"><div>æ–°è®¢å•</div><div class="stat-number" id="countNew">0</div></div>
            <div class="stat-box"><div>åˆ¶ä½œä¸­</div><div class="stat-number" id="countCooking">0</div></div>
            <div class="stat-box"><div>æ€»å¾…å¤„ç†</div><div class="stat-number" id="countTotal">0</div></div>
        </div>
        <div id="ordersContainer" class="orders-container">
            <div class="empty-state" id="emptyState">
                <i class="fas fa-utensils"></i>
                <h3>æš‚æ— å¾…å¤„ç†è®¢å•</h3>
                <p>æ–°è®¢å•å°†åœ¨è¿™é‡Œå®æ—¶æ˜¾ç¤ºå¹¶æ’­æ”¾æç¤ºéŸ³</p>
            </div>
        </div>
    </div>

    <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
    <script>
        // ==================== é…ç½®åŒº (å¿…é¡»å’Œå‰å°ä¸€è‡´!) ====================
        const SUPABASE_URL = 'https://xpipcumwxnvkllcqvsql.supabase.co'; // æ›¿æ¢ä¸ºä½ çš„URL
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InhwaXBjdW13eG52a2xsY3F2c3FsIiwicm9sZSI6ImFub24iLCJpYXQiOjE3Njc5MjU5NDIsImV4cCI6MjA4MzUwMTk0Mn0.X_qVVwYCxFhM1ScgAal2l-rKaOOQIwRx04t8agvv5cg'; // æ›¿æ¢ä¸ºä½ çš„å¯†é’¥
        // =========================================================

        const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
        let allOrders = [];
        let soundOptions = [];
        let selectedSoundUrl = '';
        const notificationAudio = new Audio();

        // åˆå§‹åŒ–
        async function initKitchen() {
            await Promise.all([loadExistingOrders(), loadSoundOptions()]);
            setupRealtimeSubscription(); // è®¾ç½®å®æ—¶ç›‘å¬
            showSystemAlert('åå¨ç³»ç»Ÿå·²å¯åŠ¨', 'æ­£åœ¨å®æ—¶ç›‘å¬æ–°è®¢å•...', 'info');
        }

        // åŠ è½½ç°æœ‰æœªå®Œæˆè®¢å•
        async function loadExistingOrders() {
            const { data, error } = await supabase
                .from('orders')
                .select('*')
                .neq('status', 'done')
                .order('created_at', { ascending: false });
            if (error) console.error('åŠ è½½è®¢å•å¤±è´¥:', error);
            else {
                allOrders = data || [];
                renderOrders();
                updateStats();
            }
        }

        // åŠ è½½é“ƒå£°é€‰é¡¹
        async function loadSoundOptions() {
            const { data, error } = await supabase.from('sound_options').select('*').order('id');
            if (error) console.error('åŠ è½½æç¤ºéŸ³å¤±è´¥:', error);
            else {
                soundOptions = data || [];
                const select = document.getElementById('soundSelect');
                select.innerHTML = '<option value="">-- é€‰æ‹©æç¤ºéŸ³ --</option>' +
                    soundOptions.map(s => `<option value="${s.url}">${s.name}</option>`).join('');
                // é»˜è®¤é€‰æ‹©ç¬¬ä¸€ä¸ª
                if (soundOptions.length > 0) {
                    select.value = soundOptions[0].url;
                    selectedSoundUrl = soundOptions[0].url;
                }
                select.onchange = (e) => selectedSoundUrl = e.target.value;
            }
        }

        // è®¾ç½®å®æ—¶ç›‘å¬
        function setupRealtimeSubscription() {
            const channel = supabase
                .channel('kitchen-orders')
                .on('postgres_changes', { event: 'INSERT', schema: 'public', table: 'orders' }, (payload) => {
                    console.log('æ–°è®¢å•!', payload.new);
                    handleNewOrder(payload.new);
                })
                .on('postgres_changes', { event: 'UPDATE', schema: 'public', table: 'orders' }, (payload) => {
                    console.log('è®¢å•æ›´æ–°!', payload.new);
                    updateOrderInList(payload.new);
                })
                .subscribe(status => console.log('å®æ—¶è®¢é˜…çŠ¶æ€:', status));
        }

        function handleNewOrder(newOrder) {
            allOrders.unshift(newOrder); // æ–°è®¢å•æ”¾æœ€å‰é¢
            renderOrders();
            updateStats();
            playNotificationSound(); // æ’­æ”¾æç¤ºéŸ³
            showSystemAlert('æ–°è®¢å•ï¼', `è®¢å• #${newOrder.id} å·²æ”¶åˆ°`, 'success');
        }

        function updateOrderInList(updatedOrder) {
            const index = allOrders.findIndex(o => o.id === updatedOrder.id);
            if (index !== -1) {
                if (updatedOrder.status === 'done') {
                    allOrders.splice(index, 1);
                } else {
                    allOrders[index] = updatedOrder;
                }
                renderOrders();
                updateStats();
            }
        }

        // æ¸²æŸ“æ‰€æœ‰è®¢å•
        function renderOrders() {
            const container = document.getElementById('ordersContainer');
            const emptyEl = document.getElementById('emptyState');
            if (allOrders.length === 0) {
                emptyEl.style.display = 'block';
                container.innerHTML = '';
                container.appendChild(emptyEl);
                return;
            }
            emptyEl.style.display = 'none';
            container.innerHTML = allOrders.map(order => {
                const orderTime = new Date(order.created_at).toLocaleTimeString('zh-CN');
                let total = 0;
                const itemsHtml = order.items.map(item => {
                    const subtotal = item.price * item.quantity;
                    total += subtotal;
                    return `
                        <div class="order-item">
                            <span>${item.name} Ã—${item.quantity}</span>
                            <span class="item-total">Â¥${subtotal.toFixed(2)}</span>
                        </div>`;
                }).join('');
                let actionBtn = '';
                if (order.status === 'new') {
                    actionBtn = `<button class="action-btn btn-start" onclick="updateOrderStatus(${order.id}, 'cooking')"><i class="fas fa-play-circle"></i> å¼€å§‹åˆ¶ä½œ</button>`;
                } else if (order.status === 'cooking') {
                    actionBtn = `<button class="action-btn btn-finish" onclick="updateOrderStatus(${order.id}, 'done')"><i class="fas fa-check-circle"></i> åˆ¶ä½œå®Œæˆ</button>`;
                }
                return `
                    <div class="order-card ${order.status}">
                        <div class="order-header">
                            <div>
                                <div class="order-id">è®¢å• #${order.id}</div>
                                <div class="order-time">${orderTime}</div>
                            </div>
                            <div class="order-status status-${order.status}">
                                ${order.status === 'new' ? 'ğŸ†• æ–°è®¢å•' : 'ğŸ‘¨â€ğŸ³ åˆ¶ä½œä¸­'}
                            </div>
                        </div>
                        <div class="order-items">${itemsHtml}</div>
                        <div class="order-footer">
                            <div class="order-total"><strong>æ€»è®¡: <span style="color:#fbbf24; font-size:1.4em;">Â¥${total.toFixed(2)}</span></strong></div>
                            <div class="order-actions">${actionBtn}</div>
                        </div>
                    </div>`;
            }).join('');
        }

        function updateStats() {
            const countNew = allOrders.filter(o => o.status === 'new').length;
            const countCooking = allOrders.filter(o => o.status === 'cooking').length;
            document.getElementById('countNew').textContent = countNew;
            document.getElementById('countCooking').textContent = countCooking;
            document.getElementById('countTotal').textContent = allOrders.length;
        }

        // æ›´æ–°è®¢å•çŠ¶æ€
        async function updateOrderStatus(orderId, newStatus) {
            const { error } = await supabase.from('orders').update({ status: newStatus }).eq('id', orderId);
            if (error) {
                console.error('æ›´æ–°çŠ¶æ€å¤±è´¥:', error);
                alert('æ“ä½œå¤±è´¥ï¼Œè¯·é‡è¯•');
            } else {
                console.log(`è®¢å• #${orderId} çŠ¶æ€å·²æ›´æ–°ä¸º: ${newStatus}`);
            }
        }

        // æ’­æ”¾æç¤ºéŸ³
        function playNotificationSound() {
            if (!selectedSoundUrl) return;
            notificationAudio.src = selectedSoundUrl;
            notificationAudio.play().catch(e => {
                // éƒ¨åˆ†æµè§ˆå™¨è¦æ±‚ç”¨æˆ·äº¤äº’åæ‰èƒ½è‡ªåŠ¨æ’­æ”¾
                console.log('è‡ªåŠ¨æ’­æ”¾è¢«é˜»æ­¢:', e);
            });
        }

        function testSelectedSound() {
            if (!selectedSoundUrl) {
                alert('è¯·å…ˆé€‰æ‹©ä¸€ä¸ªæç¤ºéŸ³');
                return;
            }
            playNotificationSound();
        }

        function showSystemAlert(title, text, type) {
            console.log(`[${type.toUpperCase()}] ${title}: ${text}`);
            // å¯ä»¥åœ¨è¿™é‡Œå®ç°ä¸€ä¸ªæ›´é†’ç›®çš„ç•Œé¢æç¤º
        }

        document.addEventListener('DOMContentLoaded', initKitchen);
    </script>
</body>
</html>
