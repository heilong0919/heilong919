<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <title>åå¨è®¢å•æ˜¾ç¤ºç³»ç»Ÿ</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; font-family: -apple-system, system-ui, sans-serif; }
        body { background: #0f172a; color: #f8fafc; line-height: 1.6; }
        .container { max-width: 1000px; margin: 0 auto; padding: 20px; }

        header {
            background: linear-gradient(135deg, #ea580c, #dc2626);
            padding: 1.5rem; border-radius: 16px; margin-bottom: 2rem;
            text-align: center; box-shadow: 0 10px 25px rgba(234, 88, 12, 0.3);
        }
        h1 { font-size: 2rem; margin-bottom: 0.5rem; }
        .subtitle { color: rgba(255,255,255,0.9); font-size: 1.1rem; }

        .stats-bar {
            display: flex; justify-content: space-between; background: #1e293b;
            padding: 1rem; border-radius: 12px; margin-bottom: 1.5rem;
            font-size: 1.1rem;
        }
        .stat-item { text-align: center; }
        .stat-number { font-size: 2rem; font-weight: 800; color: #fbbf24; }

        .orders-container { display: flex; flex-direction: column; gap: 1.5rem; }
        .order-card {
            background: #1e293b; border-radius: 16px; padding: 1.8rem;
            border-left: 6px solid #ea580c; box-shadow: 0 10px 20px rgba(0,0,0,0.2);
            animation: pulse-new 2s infinite;
        }
        .order-card.cooking { border-left-color: #0ea5e9; animation: none; }
        .order-card.done { border-left-color: #10b981; opacity: 0.7; animation: none; }
        @keyframes pulse-new {
            0% { box-shadow: 0 0 0 0 rgba(234, 88, 12, 0.5); }
            70% { box-shadow: 0 0 0 12px rgba(234, 88, 12, 0); }
            100% { box-shadow: 0 0 0 0 rgba(234, 88, 12, 0); }
        }

        .order-header {
            display: flex; justify-content: space-between; align-items: center;
            margin-bottom: 1.2rem; padding-bottom: 1rem; border-bottom: 2px solid #334155;
        }
        .order-id { font-size: 1.5rem; font-weight: 800; color: #fbbf24; }
        .order-time { color: #94a3b8; font-size: 0.95rem; }
        .order-status {
            padding: 6px 16px; border-radius: 20px; font-weight: 700; font-size: 0.9rem;
        }
        .status-new { background: #fed7aa; color: #9a3412; }
        .status-cooking { background: #bae6fd; color: #075985; }
        .status-done { background: #bbf7d0; color: #166534; }

        .order-items { margin: 1.5rem 0; }
        .order-item {
            display: flex; justify-content: space-between; padding: 0.8rem 0;
            border-bottom: 1px dashed #475569;
        }
        .item-total { font-weight: 700; color: #fbbf24; }

        .order-footer {
            display: flex; justify-content: space-between; align-items: center;
            margin-top: 1.5rem; padding-top: 1.2rem; border-top: 2px solid #334155;
            font-size: 1.2rem;
        }
        .order-actions { display: flex; gap: 1rem; }
        .action-btn {
            padding: 10px 20px; border: none; border-radius: 8px; font-weight: 700;
            cursor: pointer; display: flex; align-items: center; gap: 8px; transition: all 0.2s;
        }
        .btn-start { background: #0ea5e9; color: white; }
        .btn-finish { background: #10b981; color: white; }
        .action-btn:hover { transform: translateY(-3px); box-shadow: 0 5px 15px rgba(0,0,0,0.3); }

        .empty-state {
            text-align: center; padding: 4rem 2rem; color: #64748b;
        }
        .empty-state i { font-size: 4rem; margin-bottom: 1.5rem; color: #334155; }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1><i class="fas fa-fire"></i> åå¨è®¢å•æ˜¾ç¤ºç³»ç»Ÿ</h1>
            <p class="subtitle">å®æ—¶è®¢å•ç›‘æ§ | çŠ¶æ€æ›´æ–° | å£°éŸ³æé†’</p >
        </header>

        <div class="stats-bar">
            <div class="stat-item">
                <div>æ–°è®¢å•</div>
                <div class="stat-number" id="countNew">0</div>
            </div>
            <div class="stat-item">
                <div>åˆ¶ä½œä¸­</div>
                <div class="stat-number" id="countCooking">0</div>
            </div>
            <div class="stat-item">
                <div>å¾…å¤„ç†</div>
                <div class="stat-number" id="countTotal">0</div>
            </div>
        </div>

        <div id="ordersContainer" class="orders-container">
            <div class="empty-state" id="emptyState">
                <i class="fas fa-utensils"></i>
                <h3>æš‚æ— å¾…å¤„ç†è®¢å•</h3>
                <p>æ–°è®¢å•å°†åœ¨è¿™é‡Œå®æ—¶æ˜¾ç¤ºå¹¶æ’­æ”¾æç¤ºéŸ³</p >
            </div>
            <!-- è®¢å•å¡ç‰‡å°†ç”±JavaScriptåŠ¨æ€ç”Ÿæˆ -->
        </div>
    </div>

    <!-- å¼•å…¥Supabase JS SDK -->
    <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
    <script>
        // ====================== é…ç½®åŒºåŸŸ ======================
        // !!! é‡è¦ï¼šå°†ä»¥ä¸‹ä¸¤ä¸ªå€¼æ›¿æ¢æˆä½ è‡ªå·±çš„Supabaseé¡¹ç›®ä¿¡æ¯ï¼ˆä¸å‰å°ç›¸åŒï¼‰ !!!
        const SUPABASE_URL = 'https://xpipcumwxnvkllcqvsql.supabase.co'; // æ›¿æ¢ä¸ºä½ çš„ URL
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InhwaXBjdW13eG52a2xsY3F2c3FsIiwicm9sZSI6ImFub24iLCJpYXQiOjE3Njc5MjU5NDIsImV4cCI6MjA4MzUwMTk0Mn0.X_qVVwYCxFhM1ScgAal2l-rKaOOQIwRx04t8agvv5cg'; // æ›¿æ¢ä¸ºä½ çš„ Anon Key
        // ====================================================

        // åˆå§‹åŒ–Supabaseå®¢æˆ·ç«¯
        const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

        // å…¨å±€çŠ¶æ€
        let allOrders = []; // å­˜å‚¨ä»æ•°æ®åº“è·å–çš„è®¢å•

        // éŸ³é¢‘å¯¹è±¡ç”¨äºæ’­æ”¾æç¤ºéŸ³
        const notificationAudio = new Audio();

        // ====================== åˆå§‹åŒ–ä¸å®æ—¶ç›‘å¬ ======================
        async function initKitchenDisplay() {
            // 1. åŠ è½½ç°æœ‰çš„æœªå®Œæˆè®¢å•
            await loadExistingOrders();

            // 2. ã€æ ¸å¿ƒã€‘è®¾ç½®å®æ—¶ç›‘å¬ï¼Œç›‘å¬æ•°æ®åº“çš„â€œæ’å…¥â€å’Œâ€œæ›´æ–°â€äº‹ä»¶
            const channel = supabase
                .channel('kitchen-orders-live')
                .on(
                    'postgres_changes',
                    {
                        event: 'INSERT',
                        schema: 'public',
                        table: 'orders',
                    },
                    (payload) => {
                        // å½“æœ‰æ–°çš„è®¢å•æ’å…¥æ—¶
                        console.log('ğŸ”” æ”¶åˆ°æ–°è®¢å•ï¼', payload.new);
                        handleNewOrder(payload.new);
                    }
                )
                .on(
                    'postgres_changes',
                    {
                        event: 'UPDATE',
                        schema: 'public',
                        table: 'orders',
                    },
                    (payload) => {
                        // å½“è®¢å•çŠ¶æ€è¢«æ›´æ–°æ—¶ï¼ˆå¦‚å‰å…æ ‡è®°å®Œæˆï¼‰
                        console.log('ğŸ“ è®¢å•çŠ¶æ€æ›´æ–°', payload.new);
                        updateOrderInList(payload.new);
                    }
                )
                .subscribe();

            console.log('åå¨æ˜¾ç¤ºç³»ç»Ÿå·²å¯åŠ¨ï¼Œæ­£åœ¨ç›‘å¬å®æ—¶è®¢å•...');
        }

        async function loadExistingOrders() {
            // è·å–æ‰€æœ‰çŠ¶æ€ä¸ä¸º â€˜doneâ€˜ çš„è®¢å•ï¼ŒæŒ‰åˆ›å»ºæ—¶é—´å€’åºæ’åˆ—
            const { data, error } = await supabase
                .from('orders')
                .select('*')
                .neq('status', 'done')
                .order('created_at', { ascending: false });

            if (error) {
                console.error('åŠ è½½ç°æœ‰è®¢å•å¤±è´¥:', error);
                return;
            }
            allOrders = data || [];
            renderAllOrders();
            updateStats();
        }

        // ====================== è®¢å•å¤„ç†å‡½æ•° ======================
        function handleNewOrder(newOrder) {
            // å°†æ–°è®¢å•æ·»åŠ åˆ°åˆ—è¡¨æœ€å‰é¢
            allOrders.unshift(newOrder);
            renderAllOrders();
            updateStats();
            // æ’­æ”¾æç¤ºéŸ³
            playNotificationSound();
            // å¯ä»¥æ·»åŠ æ›´é†’ç›®çš„è§†è§‰æç¤ºï¼ˆå¦‚é—ªçƒï¼‰
            showNewOrderAlert(`æ–°è®¢å• #${newOrder.id} å·²æ”¶åˆ°ï¼`);
        }

        function updateOrderInList(updatedOrder) {
            // æ‰¾åˆ°åˆ—è¡¨ä¸­å¯¹åº”çš„è®¢å•å¹¶æ›´æ–°
            const index = allOrders.findIndex(order => order.id === updatedOrder.id);
            if (index !== -1) {
                // å¦‚æœè®¢å•è¢«æ ‡è®°ä¸ºå®Œæˆï¼Œåˆ™ä»å½“å‰æ˜¾ç¤ºåˆ—è¡¨ä¸­ç§»é™¤
                if (updatedOrder.status === 'done') {
                    allOrders.splice(index, 1);
                } else {
                    allOrders[index] = updatedOrder;
                }
                renderAllOrders();
                updateStats();
            }
        }

        // ====================== æ¸²æŸ“ä¸æ›´æ–°UI ======================
        function renderAllOrders() {
            const container = document.getElementById('ordersContainer');
            const emptyState = document.getElementById('emptyState');

            if (allOrders.length === 0) {
                emptyState.style.display = 'block';
                container.innerHTML = '';
                container.appendChild(emptyState);
                return;
            }

            emptyState.style.display = 'none';

            // ç”Ÿæˆæ‰€æœ‰è®¢å•å¡ç‰‡çš„HTML
            container.innerHTML = allOrders.map(order => {
                const orderTime = new Date(order.created_at).toLocaleTimeString('zh-CN');
                let totalAmount = 0;
                const itemsHtml = order.items.map(item => {
                    const subtotal = item.price * item.quantity;
                    totalAmount += subtotal;
                    return `
                        <div class="order-item">
                            <span>${item.name} x${item.quantity}</span>
                            <span class="item-total">Â¥${subtotal.toFixed(2)}</span>
                        </div>
                    `;
                }).join('');

                // æ ¹æ®çŠ¶æ€ç¡®å®šæ˜¾ç¤ºçš„æŒ‰é’®
                let actionButtons = '';
                if (order.status === 'new') {
                    actionButtons = `
                        <button class="action-btn btn-start" onclick="updateOrderStatus(${order.id}, 'cooking')">
                            <i class="fas fa-play-circle"></i> å¼€å§‹åˆ¶ä½œ
                        </button>
                    `;
                } else if (order.status === 'cooking') {
                    actionButtons = `
                        <button class="action-btn btn-finish" onclick="updateOrderStatus(${order.id}, 'done')">
                            <i class="fas fa-check-circle"></i> åˆ¶ä½œå®Œæˆ
                        </button>
                    `;
                }

                return `
                    <div class="order-card ${order.status}">
                        <div class="order-header">
                            <div>
                                <div class="order-id">è®¢å• #${order.id}</div>
                                <div class="order-time">${orderTime}</div>
                            </div>
                            <div class="order-status status-${order.status}">
                                ${order.status === 'new' ? 'æ–°è®¢å•' : order.status === 'cooking' ? 'åˆ¶ä½œä¸­' : 'å·²å®Œæˆ'}
                            </div>
                        </div>
                        <div class="order-items">
                            ${itemsHtml}
                        </div>
                        <div class="order-footer">
                            <div class="order-total">
                                <strong>æ€»è®¡: <span style="color:#fbbf24; font-size:1.4rem;">Â¥${totalAmount.toFixed(2)}</span></strong>
                            </div>
                            <div class="order-actions">
                                ${actionButtons}
                            </div>
                        </div>
                    </div>
                `;
            }).join('');
        }

        function updateStats() {
            const countNew = allOrders.filter(o => o.status === 'new').length;
            const countCooking = allOrders.filter(o => o.status === 'cooking').length;
            document.getElementById('countNew').textContent = countNew;
            document.getElementById('countCooking').textContent = countCooking;
            document.getElementById('countTotal').textContent = allOrders.length;
        }

        // ====================== äº¤äº’åŠŸèƒ½ ======================
        // æ›´æ–°è®¢å•çŠ¶æ€ï¼ˆå¼€å§‹åˆ¶ä½œ/åˆ¶ä½œå®Œæˆï¼‰
        async function updateOrderStatus(orderId, newStatus) {
            const { error } = await supabase
                .from('orders')
                .update({ status: newStatus })
                .eq('id', orderId);

            if (error) {
                console.error('æ›´æ–°è®¢å•çŠ¶æ€å¤±è´¥:', error);
                alert('æ“ä½œå¤±è´¥ï¼Œè¯·ç¨åé‡è¯•ã€‚');
            } else {
                console.log(`è®¢å• #${orderId} çŠ¶æ€å·²æ›´æ–°ä¸º: ${newStatus}`);
                // çŠ¶æ€æ›´æ–°åï¼Œå®æ—¶ç›‘å¬ä¼šæ”¶åˆ°UPDATEäº‹ä»¶ï¼ŒUIä¼šè‡ªåŠ¨æ›´æ–°
            }
        }

        // æ’­æ”¾æ–°è®¢å•æç¤ºéŸ³ï¼ˆä½¿ç”¨ä¸€ä¸ªå¯é çš„é»˜è®¤éŸ³æ•ˆï¼‰
        function playNotificationSound() {
            // ä½¿ç”¨ä¸€ä¸ªå¯é çš„åœ¨çº¿æç¤ºéŸ³
            notificationAudio.src = 'https://assets.mixkit.co/sfx/preview/mixkit-bell-notification-933.mp3';
            notificationAudio.play().catch(e => {
                // éƒ¨åˆ†æµè§ˆå™¨è¦æ±‚å¿…é¡»æœ‰ç”¨æˆ·äº¤äº’æ‰èƒ½è‡ªåŠ¨æ’­æ”¾ï¼Œè¿™é‡Œå¿½ç•¥é”™è¯¯
                console.log('æç¤ºéŸ³è‡ªåŠ¨æ’­æ”¾è¢«é˜»æ­¢ï¼Œéœ€è¦ç”¨æˆ·å…ˆä¸é¡µé¢äº¤äº’ï¼ˆå¦‚ç‚¹å‡»ï¼‰ã€‚');
            });
        }

        // æ˜¾ç¤ºæ–°è®¢å•æé†’ï¼ˆå¯é€‰ï¼‰
        function showNewOrderAlert(message) {
            // å¯ä»¥åˆ›å»ºä¸€ä¸ªä¸´æ—¶å¼¹å‡ºçš„æç¤ºï¼Œè¿™é‡Œç”¨ç®€å•çš„alertæ›¿ä»£
            // åœ¨å®é™…ä½¿ç”¨ä¸­ï¼Œå»ºè®®æ›¿æ¢æˆæ›´å‹å¥½çš„éé˜»å¡å¼æç¤º
            console.log('ğŸš¨ ' + message);
        }

        // ====================== å¯åŠ¨åº”ç”¨ ======================
        document.addEventListener('DOMContentLoaded', initKitchenDisplay);
    </script>
</body>
</html>